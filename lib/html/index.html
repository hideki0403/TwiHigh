<!DOCTYPE html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TwiHigh</title>

    <!-- CSS読み込み  -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="css/materialize.css" type="text/css" rel="stylesheet" media="screen,projection" />
    <link href="css/style.css" type="text/css" rel="stylesheet" media="screen,projection" />
    <link href="css/theme/main.css" type="text/css" rel="stylesheet" media="screen,projection" />
    <link href="css/twihigh_style.css" type="text/css" rel="stylesheet" media="screen,projection" />

</head>

<body class='main_background'>
  <div class='twihigh_container'>
    <div class='row'>
      <div class="col s4">
        <!-- LeftContents -->
        <div class="account">
          <div id="accountBox" class="row" >
          </div>
        </div>
        <div class='tweet-box'>
          <textarea class="textarea-twihigh"></textarea>
          <hr />
          <button class="btn waves-effect waves-light blue btn-small right-align" type="submit" name="action" onClick="tweetToTwitter()">Tweet
            <i class="material-icons right">send</i>
          </button>
          <button class="btn-floating waves-effect waves-light blue btn-small" type="submit" name="action"><i class="material-icons right">add_a_photo</i></button>
        </div>

        <div id="levelBox" class="level-box">
          勇者 hideki0403 [LV:1/EXP:325]
          <hr />
          いいねをした！32EXP獲得！
        </div>
      </div>
      <div class="col s8">
        <button class="btn waves-effect waves-light red btn-small" type="submit" name="action" onClick="$('#timeline').empty()">TL Clear
          <i class="material-icons right">clear</i>
        </button>
        <span id="tweetsBadge" class="new badge" data-badge-caption="tweets/s">0</span>
        <!-- TL -->
        <div id="timeline"></div>
    </div>
  </div>
    <!-- Script系読み込み -->
    <script>
      window.jQuery = window.$ = require('jquery')
    </script>
    <script src="js/materialize.js"></script>
    <script src="js/init.js"></script>
    <script src="js/loadCss.js"></script>
    <!-- materialize -->
    <script>
      $(document).ready(function(){
        $('.materialboxed').materialbox()
      })
    </script>
    <!-- IPC通信 -->
    <script>
      var ipcRenderer = require('electron').ipcRenderer
      var i = 0
      var t = 0
      setInterval(function() {
        t++
        var result = (Math.round(i / t * 10000)) / 10000
        $('#tweetsBadge').empty()
        $('#tweetsBadge').append(result)
      }, 1000)
      ipcRenderer.on('stream', (event, MData) => {
        i++
        var tweet = MData.ev
        var TTid = MData.id
        var image = MData.img

        if(tweet.text.match(/RT/)) {
          $('#timeline').prepend('<div class="tweet_rt"><span class="box-title">' + tweet.user.name + ' (@' + tweet.user.screen_name + ')</span><p id="addMedia-' + tweet.id_str + '">' + tweet.text + '</p><p class="via_charactor">' + tweet.source + '</p></div>')
        } else {
          $('#timeline').prepend('<div class="tweet_normal"><span class="box-title">' + tweet.user.name + ' (@' + tweet.user.screen_name + ')</span><p id="addMedia-' + tweet.id_str + '">' + tweet.text + '</p><p class="via_charactor">' + tweet.source + '</p><hr /><i class="material-icons tiny" id="' + tweet.id_str + '-fav">favorite</i>いいね　<i class="material-icons tiny" id="' + tweet.id_str + '-rt">repeat</i>リツイート　<i class="material-icons tiny" id="' + tweet.id_str + '-favrt">grade</i>ふぁぼりつ</div>')
          $('#' + tweet.id_str + '-fav').click(function(){
            ipcTwitter('favorite', tweet.id_str)
          })
          $('#' + tweet.id_str + '-rt').click(function(){
            ipcTwitter('retweet', tweet.id_str)
          })
          $('#' + tweet.id_str + '-favrt').click(function(){
            ipcTwitter('favrt', tweet.id_str)
          })
        }

        // Media追加
        if(MData.video !== null) {
          $('#addMedia-' + tweet.id_str).append('<br clear="all"><video class="responsive-video" controls><source src="' + MData.video + '" type="video/mp4"></video>')
        } else {
          if(MData.img !== null) {
            switch(MData.img.length) {
              case 1:
                $('#addMedia-' + tweet.id_str).append('<br clear="all"><img class="materialboxed img-single" src="' + image[0].media_url + '">')
                break
              case 2:
                $('#addMedia-' + tweet.id_str).append('<br clear="all"><img class="materialboxed img-dual" src="' + image[0].media_url + '"><img class="materialboxed img-dual" src="' + image[1].media_url + '">')
                break
              case 3:
                $('#addMedia-' + tweet.id_str).append('<br clear="all"><img class="materialboxed img-triple" src="' + image[0].media_url + '"><img class="materialboxed img-triple" src="' + image[1].media_url + '"><img class="materialboxed img-triple" src="' + image[2].media_url + '">')
                break
              case 4:
                $('#addMedia-' + tweet.id_str).append('<br clear="all"><img class="materialboxed img-quad" src="' + image[0].media_url + '"><img class="materialboxed img-quad" src="' + image[1].media_url + '"><img class="materialboxed img-quad" src="' + image[2].media_url + '"><img class="materialboxed img-quad" src="' + image[3].media_url + '">')
                break
            }
          }
        }

      })

      ipcRenderer.on('accountData', (event, data) => {
        $('#accountBox').append('<div class="col s3"><img src="' + data.icon + '" class="circle responsive-img"></div>')
        $('#accountBox').append('<div class="col s9"><p>' + data.name + '</p></div>')
      })

      ipcRenderer.on('ipcTwitter-reply', (event, data) => {
        if(data.match(/エラー/)) {
          M.toast({html: '<div class="toast-error">' + data + '</div>'})
        } else {
          M.toast({html: '<div class="toast-success">' + data + '</div>'})
        }
      })

      function ipcTwitter(status, recieveID) {
        ipcRenderer.send('ipcTwitter', {status: status, id: recieveID})
      }

      function tweetToTwitter() {

      }
    </script>

</body>

</html>
